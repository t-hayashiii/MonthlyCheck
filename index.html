<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
<title>習慣記録</title>
<script src="https://cdn.tailwindcss.com"></script>

<style>
  body { overflow-x: hidden; }

  /* スマホ最適化：フォント拡大 + カラムを広く見せる */
  @media (max-width: 640px) {
    body { font-size: 1.25rem !important; }

    .calendar-cell { height: 125px !important; }
    .day-number { font-size: 22px !important; }
    .day-ex-item { font-size: 14px !important; }

    .content-wrap { padding: 0.5rem !important; }
  }

  .dragging { opacity: 0.4; }
</style>
</head>

<body class="bg-gray-100 text-gray-800">

<!-- ================================ -->
<!-- メイン画面 -->
<!-- ================================ -->
<div id="mainScreen">

<header class="bg-blue-600 text-white py-4 text-center text-xl font-bold">
  習慣記録
</header>

<!-- 上部の管理ボタン -->
<div class="max-w-[750px] mx-auto p-4 flex justify-end">
  <button id="openManageBtn" class="text-blue-600 underline font-bold">
    データ管理へ
  </button>
</div>

<div class="max-w-[750px] mx-auto p-4 content-wrap">

  <!-- ========== カレンダー ========== -->
  <div id="calendarArea" class="bg-white shadow rounded p-4 mb-6">

    <div class="flex justify-between items-center mb-2">
      <button id="prevMonthBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded">
        &lt; 前の月
      </button>

      <h2 id="calendarTitle" class="text-2xl font-bold"></h2>

      <button id="nextMonthBtn" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded">
        次の月 &gt;
      </button>
    </div>

    <div class="grid grid-cols-7 text-center font-bold border-b pb-1 text-sm">
      <div>月</div><div>火</div><div>水</div>
      <div>木</div><div>金</div><div>土</div><div>日</div>
    </div>

    <div id="calendarGrid" class="grid grid-cols-7 gap-1 mt-2"></div>
  </div>

  <!-- ========== 選択日の詳細 ========== -->
  <div id="detailArea" class="bg-white shadow rounded p-4 mb-6">
    <h2 id="detailTitle" class="text-lg font-bold mb-3"></h2>
    <div id="exerciseList" class="space-y-2"></div>
  </div>

</div><!-- wrapper -->

</div><!-- /mainScreen -->

<!-- ================================ -->
<!-- データ管理画面 -->
<!-- ================================ -->
<div id="manageScreen" class="hidden">

<header class="bg-blue-600 text-white py-4 text-center text-xl font-bold">
  習慣記録データ管理
</header>

<div class="max-w-[700px] mx-auto p-4 flex justify-start">
  <button id="closeManageBtn" class="text-blue-600 underline font-bold">
    メインに戻る
  </button>
</div>

<div class="max-w-[700px] mx-auto p-4">

  <div id="exerciseMasterList" class="space-y-3 mb-6"></div>

  <button id="openNewDialog"
          class="px-4 py-2 bg-blue-500 text-white rounded font-bold">
    新規追加
  </button>

  <hr class="my-6"/>

  <div class="flex space-x-4">

    <!-- 文言修正済 -->
    <button id="resetDataBtn" 
            class="px-4 py-2 bg-red-500 text-white rounded font-bold">
      全データを初期化
    </button>

    <button id="deleteAllExercisesBtn"
            class="px-4 py-2 bg-red-500 text-white rounded font-bold">
      全データを削除
    </button>

  </div>

</div>
</div><!-- /manageScreen -->


<!-- ================================ -->
<!-- 新規 / 修正ダイアログ -->
<!-- ================================ -->
<div id="editDialog" class="fixed inset-0 bg-black/50 flex items-center justify-center hidden">
  <div class="bg-white p-6 rounded shadow w-80">

    <h2 id="dialogTitle" class="font-bold text-lg mb-4"></h2>

    <input id="dlgName" class="border p-1 w-full mb-3 text-sm" placeholder="習慣名" />

    <div class="mb-1 text-sm font-bold">行う曜日</div>
    <div id="dlgWeekBtns" class="flex flex-wrap gap-1 mb-3"></div>

    <input id="dlgLink" 
           class="border p-1 w-full mb-4 text-sm" 
           placeholder="動画リンク URL（任意）" />

    <div class="flex justify-end space-x-2">
      <button id="dlgCancel" class="px-3 py-1 bg-gray-300 rounded font-bold">
        キャンセル
      </button>
      <button id="dlgSave" class="px-3 py-1 bg-blue-500 text-white rounded font-bold">
        保存
      </button>
    </div>

  </div>
</div>

<script>
/* ================================
   ローカルストレージ I/O
================================ */
function loadExercises() {
  return JSON.parse(localStorage.getItem("exerciseMaster") || "null");
}
function saveExercises(data) {
  localStorage.setItem("exerciseMaster", JSON.stringify(data));
}

function loadRecords() {
  return JSON.parse(localStorage.getItem("exerciseRecords") || "{}");
}
function saveRecords(data) {
  localStorage.setItem("exerciseRecords", JSON.stringify(data));
}

/* ================================
   初期データ（リンク含む）
================================ */
const defaultExercises = [
    { name: "目", days: ["月","火","水","木","金","土","日"], link: "" },
    { name: "ラジオ体操", days: ["月","火","水","木","金","土","日"], link: "https://www.google.com/url?q=https://youtu.be/5NCSDYUhVY8?si%3DVg92LeOVzkG53yHI" },
    { name: "スクワット", days: ["月","水","金"], link: "https://www.google.com/url?q=https://youtu.be/Wjp7V0EK0Zg" },
    { name: "プランク1", days: ["月","水","金","日"], link: "https://www.google.com/url?q=https://youtu.be/UgkU2S8VUX4" },
    { name: "プランク2", days: ["月","水","金","日"], link: "https://www.google.com/url?q=https://youtu.be/AKUGmosS7fM" },
    { name: "ニートゥチェスト", days: ["月","水","金"], link: "https://www.google.com/url?q=https://youtu.be/BNsM_aI0aBo" },
    { name: "腕立て伏せ", days: ["火","木","土"], link: "https://www.google.com/url?q=https://youtu.be/IdQESpQE9ew" },
    { name: "階段昇降", days: ["火","木","土"], link: "https://www.google.com/url?q=https://youtu.be/cTUwn1fgo9M" },
    { name: "ストレッチ", days: ["月","火","水","木","金","土","日"], link: "https://www.google.com/url?q=https://youtu.be/anHktHYc3cA" }
];

/* ================================
   グローバル変数
================================ */
let exerciseMaster = loadExercises();
if (!exerciseMaster) {
  exerciseMaster = JSON.parse(JSON.stringify(defaultExercises));
  saveExercises(exerciseMaster);
}

let exerciseRecords = loadRecords();

let currentDate = new Date();
let selectedDate = new Date();

/* ================================
   カレンダー描画
================================ */
function buildCalendar() {

  const year = currentDate.getFullYear();
  const month = currentDate.getMonth();

  document.getElementById("calendarTitle").textContent =
    `${year}年 ${month + 1}月`;

  const firstDay = new Date(year, month, 1);
  const startWeek = (firstDay.getDay() + 6) % 7;
  const lastDay = new Date(year, month + 1, 0).getDate();

  const grid = document.getElementById("calendarGrid");
  grid.innerHTML = "";

  for (let i = 0; i < startWeek; i++) {
    const cell = document.createElement("div");
    cell.className = "calendar-cell h-32 border rounded bg-white";
    grid.appendChild(cell);
  }

  for (let d = 1; d <= lastDay; d++) {

    const date = new Date(year, month, d);
    const wday = ["日","月","火","水","木","金","土"][date.getDay()];

    const cell = document.createElement("div");
    cell.className =
      "calendar-cell h-32 border rounded bg-white overflow-hidden p-1 cursor-pointer hover:bg-blue-50";

    cell.onclick = () => {
      selectedDate = date;
      showDetail(date);
    };

    const title = document.createElement("div");
    title.className = "day-number font-bold mb-1";
    title.textContent = d;
    cell.appendChild(title);

    exerciseMaster.forEach(ex => {
      if (ex.days.includes(wday)) {

        const div = document.createElement("div");
        div.className = "day-ex-item leading-tight text-[12px]";

        /* 3文字表示 */
        div.textContent = ex.name.slice(0, 3);

        div.classList.add("text-gray-400");

        const key = date.toISOString().slice(0,10);
        const rec = exerciseRecords[key]?.[ex.name];

        if (rec?.done) {
          div.classList.remove("text-gray-400");
          div.classList.add("text-blue-600", "font-bold");
        }

        cell.appendChild(div);
      }
    });

    grid.appendChild(cell);
  }
}

document.getElementById("prevMonthBtn").onclick = () => {
  currentDate.setMonth(currentDate.getMonth() - 1);
  buildCalendar();
};
document.getElementById("nextMonthBtn").onclick = () => {
  currentDate.setMonth(currentDate.getMonth() + 1);
  buildCalendar();
};


/* ================================
   詳細表示
================================ */
function showDetail(date) {

  const m = date.getMonth() + 1;
  const d = date.getDate();
  const w = ["日","月","火","水","木","金","土"][date.getDay()];

  document.getElementById("detailTitle").textContent =
    `${m}月${d}日（${w}） の習慣`;

  const list = document.getElementById("exerciseList");
  list.innerHTML = "";

  const key = date.toISOString().slice(0,10);

  exerciseMaster.forEach(ex => {
    if (!ex.days.includes(w)) return;

    const row = document.createElement("div");
    row.className = "flex items-center bg-blue-50/40 rounded p-2";

    const rec = exerciseRecords[key]?.[ex.name];

    const chk = document.createElement("input");
    chk.type = "checkbox";
    chk.checked = rec?.done ? true : false;
    chk.className = "w-5 h-5 mr-3";

    const name = document.createElement("span");
    name.textContent = ex.name;
    name.className = "mr-3";

    if (rec?.done) {
      name.classList.add("font-bold", "text-blue-700");
      row.classList.add("bg-blue-50");
    }

    const time = document.createElement("span");
    time.className = "text-sm text-gray-600";
    time.textContent = rec?.time ?? "";

    chk.onchange = () => {
      if (!exerciseRecords[key]) exerciseRecords[key] = {};

      if (chk.checked) {
        const now = new Date();
        const t = `${now.getHours()}:${String(now.getMinutes()).padStart(2,"0")}`;
        exerciseRecords[key][ex.name] = { done: true, time: t };
      } else {
        delete exerciseRecords[key][ex.name];
      }

      saveRecords(exerciseRecords);
      showDetail(date);
      buildCalendar();
    };

    row.appendChild(chk);
    row.appendChild(name);

    if (ex.link) {
      const btn = document.createElement("a");
      btn.href = ex.link;
      btn.target = "_blank";
      btn.textContent = "動画";
      btn.className =
        "px-2 py-1 text-xs bg-gray-300 rounded mr-3 hover:bg-gray-400";
      row.appendChild(btn);
    }

    row.appendChild(time);
    list.appendChild(row);
  });
}


/* ================================
   データ管理画面
================================ */
document.getElementById("openManageBtn").onclick = () => {
  document.getElementById("mainScreen").classList.add("hidden");
  document.getElementById("manageScreen").classList.remove("hidden");
  refreshManageList();
};

document.getElementById("closeManageBtn").onclick = () => {
  document.getElementById("manageScreen").classList.add("hidden");
  document.getElementById("mainScreen").classList.remove("hidden");
  buildCalendar();
  showDetail(selectedDate);
};


function refreshManageList() {

  const list = document.getElementById("exerciseMasterList");
  list.innerHTML = "";

  exerciseMaster.forEach((ex, idx) => {

    const row = document.createElement("div");
    row.draggable = true;
    row.dataset.index = idx;
    row.className =
      "border bg-white p-3 rounded shadow flex items-center justify-between";

    row.ondragstart = e => {
      e.dataTransfer.setData("text/plain", idx);
      row.classList.add("dragging");
    };
    row.ondragend = () => row.classList.remove("dragging");

    row.ondragover = e => e.preventDefault();
    row.ondrop = e => {
      e.preventDefault();
      const from = Number(e.dataTransfer.getData("text/plain"));
      const to = idx;

      const temp = exerciseMaster[from];
      exerciseMaster.splice(from,1);
      exerciseMaster.splice(to,0,temp);

      saveExercises(exerciseMaster);
      refreshManageList();
    };

    const left = document.createElement("div");
    left.innerHTML =
      `<div class="font-bold text-lg">${ex.name}</div>
       <div class="text-sm text-gray-600">曜日：${ex.days.join("")}</div>`;

    const right = document.createElement("div");
    right.className = "flex space-x-2";

    const editBtn = document.createElement("button");
    editBtn.textContent = "修正";
    editBtn.className = "px-3 py-1 bg-green-500 text-white rounded font-bold";
    editBtn.onclick = () => openEditDialog(idx);

    const delBtn = document.createElement("button");
    delBtn.textContent = "削除";
    delBtn.className = "px-3 py-1 bg-red-500 text-white rounded font-bold";
    delBtn.onclick = () => {
      if (confirm("削除しますか？")) {
        exerciseMaster.splice(idx,1);
        saveExercises(exerciseMaster);
        refreshManageList();
        buildCalendar();
        showDetail(selectedDate);
      }
    };

    right.appendChild(editBtn);
    right.appendChild(delBtn);

    row.appendChild(left);
    row.appendChild(right);

    list.appendChild(row);
  });
}


/* ================================
   新規 / 修正ダイアログ
================================ */
const dialog = document.getElementById("editDialog");
let editingIndex = null;

document.getElementById("openNewDialog").onclick = () => {
  editingIndex = null;
  openDialog("新規追加");
};

function openEditDialog(idx) {
  editingIndex = idx;
  openDialog("修正", exerciseMaster[idx]);
}

function openDialog(title, data=null) {

  document.getElementById("dialogTitle").textContent = title;
  document.getElementById("dlgName").value = data?.name || "";
  document.getElementById("dlgLink").value = data?.link || "";

  const days = ["月","火","水","木","金","土","日"];
  const area = document.getElementById("dlgWeekBtns");
  area.innerHTML = "";

  days.forEach(d => {
    const b = document.createElement("button");
    b.textContent = d;

    b.className =
      "px-2 py-1 border rounded text-sm " +
      (data?.days.includes(d)
        ? "bg-blue-500 text-white"
        : "bg-gray-200 text-gray-700");

    b.onclick = () => {
      if (b.classList.contains("bg-blue-500")) {
        b.classList.remove("bg-blue-500","text-white");
        b.classList.add("bg-gray-200","text-gray-700");
      } else {
        b.classList.remove("bg-gray-200","text-gray-700");
        b.classList.add("bg-blue-500","text-white");
      }
    };

    area.appendChild(b);
  });

  dialog.classList.remove("hidden");
}

document.getElementById("dlgCancel").onclick = () => {
  dialog.classList.add("hidden");
};

document.getElementById("dlgSave").onclick = () => {

  const name = document.getElementById("dlgName").value.trim();
  if (!name) {
    alert("習慣名を入力してください");
    return;
  }

  const link = document.getElementById("dlgLink").value.trim();

  const days = [];
  document.querySelectorAll("#dlgWeekBtns button").forEach(b => {
    if (b.classList.contains("bg-blue-500")) days.push(b.textContent);
  });

  const item = { name, link, days };

  if (editingIndex == null) {
    exerciseMaster.push(item);
  } else {
    exerciseMaster[editingIndex] = item;
  }

  saveExercises(exerciseMaster);
  dialog.classList.add("hidden");

  refreshManageList();
  buildCalendar();
  showDetail(selectedDate);
};


/* ================================
   初期化ボタン
================================ */
document.getElementById("resetDataBtn").onclick = () => {
  if (confirm("データを初期値に戻しますか？")) {
    exerciseMaster = JSON.parse(JSON.stringify(defaultExercises));
    exerciseRecords = {};
    saveExercises(exerciseMaster);
    saveRecords(exerciseRecords);
    refreshManageList();
    buildCalendar();
    showDetail(new Date());
  }
};

/* ================================
   全データ削除
================================ */
document.getElementById("deleteAllExercisesBtn").onclick = () => {
  if (confirm("すべての習慣データを削除します。よろしいですか？")) {
    exerciseMaster = [];
    exerciseRecords = {};
    saveExercises(exerciseMaster);
    saveRecords(exerciseRecords);
    refreshManageList();
    buildCalendar();
    showDetail(selectedDate);
    alert("すべての習慣データを削除しました。");
  }
};


/* ================================
   初期描画
================================ */
buildCalendar();
showDetail(selectedDate);

</script>

</body>
</html>
